{% extends 'base.html' %}
{% block title %}{{ course.title }} ‚Äî –£—á–∏—Ç—å{% endblock %}

{% block content %}
<div class="study-wrapper">

    <!-- –®–∞–ø–∫–∞ -->
    <div class="study-header">
        <a href="{% url 'course_detail' course.pk %}" class="btn-secondary">‚úï</a>
        <div class="study-progress-bar">
            <div class="study-progress-fill" id="progressFill"></div>
        </div>
        <span class="study-counter" id="counter">1 / {{ total }}</span>
    </div>

    <!-- –û–ø—Ü–∏–∏ -->
    <div class="study-options">
        <a href="?shuffle=true{% if favorites_only %}&favorites=true{% endif %}"
           class="option-chip {% if shuffle %}active{% endif %}">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</a>
        <a href="?{% if shuffle %}shuffle=true&{% endif %}favorites={% if favorites_only %}false{% else %}true{% endif %}"
           class="option-chip {% if favorites_only %}active{% endif %}">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</a>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card-scene" id="cardScene">
        <div class="card-flipper" id="cardFlipper" onclick="flipCard()">
            <div class="card-face card-front">
                <div class="card-lang" id="frontLang">{{ course.front_language|upper }}</div>
                <div class="card-word" id="frontWord"></div>
                <div class="card-image-wrap" id="cardImageWrap"></div>
                <div class="card-hint">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</div>
            </div>
            <div class="card-face card-back">
                <div class="card-lang" id="backLang">{{ course.back_language|upper }}</div>
                <div class="card-word" id="backWord"></div>
                <div class="card-hint">–ó–Ω–∞–µ—à—å? ‚Üí / –ù–µ –∑–Ω–∞–µ—à—å ‚Üê</div>
            </div>
        </div>

        <!-- –°–≤–∞–π–ø-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
        <div class="swipe-indicator know" id="indKnow">‚úì –ó–Ω–∞—é</div>
        <div class="swipe-indicator dontknow" id="indDontKnow">‚úó –ù–µ –∑–Ω–∞—é</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="study-actions">
        <button class="action-btn wrong" onclick="swipeCard('left')" title="–ù–µ –∑–Ω–∞—é">
            <span>‚úï</span>
            <small>–ù–µ –∑–Ω–∞—é</small>
        </button>
        <button class="sound-btn" onclick="speakCurrent()" title="–û–∑–≤—É—á–∏—Ç—å">üîä</button>
        <button class="action-btn correct" onclick="swipeCard('right')" title="–ó–Ω–∞—é">
            <span>‚úì</span>
            <small>–ó–Ω–∞—é</small>
        </button>
    </div>

</div>

<!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
<div class="results-screen" id="resultsScreen" style="display:none">
    <div class="results-card">
        <div class="results-emoji" id="resultsEmoji"></div>
        <h2>–ì–æ—Ç–æ–≤–æ!</h2>
        <div class="results-stats">
            <div class="stat correct-stat">
                <div class="stat-num" id="correctNum"></div>
                <div class="stat-label">–ó–Ω–∞–ª</div>
            </div>
            <div class="stat wrong-stat">
                <div class="stat-num" id="wrongNum"></div>
                <div class="stat-label">–ù–µ –∑–Ω–∞–ª</div>
            </div>
        </div>
        <div class="results-percent" id="resultsPercent"></div>
        <div class="results-actions">
            <button onclick="restartAll()" class="btn-secondary">üîÅ –ó–∞–Ω–æ–≤–æ</button>
            <button onclick="restartWrong()" class="btn-secondary" id="btnWrong">‚ùå –û—à–∏–±–∫–∏</button>
            <a href="{% url 'course_detail' course.pk %}" class="btn-secondary">üö™ –í—ã–π—Ç–∏</a>
        </div>
        <div style="margin-top:1rem">
            <a href="#" onclick="goToTest()" class="btn-primary" style="display:inline-block;width:100%;text-align:center">
                üìù –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
            </a>
        </div>
    </div>
</div>

<script>
const CARDS = {{ cards_json|safe }};
const COURSE_PK = {{ course.pk }};
const FRONT_LANG = '{{ course.front_language }}';

let currentIndex = 0;
let isFlipped = false;
let correctIds = [];
let wrongIds = [];
let activeCards = [...CARDS];

// Touch/swipe –ø–æ–¥–¥–µ—Ä–∂–∫–∞
let touchStartX = 0;
let touchStartY = 0;

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
function init() {
    showCard(0);
}

function showCard(index) {
    if (index >= activeCards.length) {
        showResults();
        return;
    }
    const card = activeCards[index];
    isFlipped = false;

    const flipper = document.getElementById('cardFlipper');
    flipper.classList.remove('flipped', 'swipe-right', 'swipe-left');

    document.getElementById('frontWord').textContent = card.front;
    document.getElementById('backWord').textContent = card.back;

    const imgWrap = document.getElementById('cardImageWrap');
    if (card.image) {
        imgWrap.innerHTML = `<img src="${card.image}" class="card-img">`;
    } else {
        imgWrap.innerHTML = '';
    }

    updateProgress(index, activeCards.length);
    document.getElementById('indKnow').style.opacity = '0';
    document.getElementById('indDontKnow').style.opacity = '0';
}

function updateProgress(index, total) {
    const pct = (index / total) * 100;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('counter').textContent = (index + 1) + ' / ' + total;
}

// ===== –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å =====
function flipCard() {
    isFlipped = !isFlipped;
    document.getElementById('cardFlipper').classList.toggle('flipped', isFlipped);
}

// ===== –°–≤–∞–π–ø =====
function swipeCard(direction) {
    if (!isFlipped) {
        flipCard();
        setTimeout(() => doSwipe(direction), 400);
    } else {
        doSwipe(direction);
    }
}

function doSwipe(direction) {
    const flipper = document.getElementById('cardFlipper');
    const card = activeCards[currentIndex];

    if (direction === 'right') {
        flipper.classList.add('swipe-right');
        correctIds.push(card.id);
        document.getElementById('indKnow').style.opacity = '1';
    } else {
        flipper.classList.add('swipe-left');
        wrongIds.push(card.id);
        document.getElementById('indDontKnow').style.opacity = '1';
    }

    setTimeout(() => {
        currentIndex++;
        showCard(currentIndex);
    }, 400);
}

// ===== Touch events =====
const scene = document.getElementById('cardScene');

scene.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

scene.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
        swipeCard(dx > 0 ? 'right' : 'left');
    } else if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
        flipCard();
    }
}, { passive: true });

// ===== –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ =====
document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight') swipeCard('right');
    if (e.key === 'ArrowLeft') swipeCard('left');
    if (e.key === ' ') { e.preventDefault(); flipCard(); }
});

// ===== –û–∑–≤—É—á–∫–∞ =====
function speakCurrent() {
    const card = activeCards[currentIndex];
    const text = isFlipped ? card.back : card.front;
    const lang = isFlipped ? '{{ course.back_language }}' : FRONT_LANG;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = lang + '-' + lang.toUpperCase();
    speechSynthesis.speak(utter);
}

// ===== –†–µ–∑—É–ª—å—Ç–∞—Ç—ã =====
function showResults() {
    const total = activeCards.length;
    const correct = correctIds.length;
    const wrong = wrongIds.length;
    const pct = Math.round((correct / total) * 100);

    document.getElementById('correctNum').textContent = correct;
    document.getElementById('wrongNum').textContent = wrong;
    document.getElementById('resultsPercent').textContent = pct + '% –ø—Ä–∞–≤–∏–ª—å–Ω–æ';

    let emoji = 'üòî';
    if (pct >= 90) emoji = 'üèÜ';
    else if (pct >= 70) emoji = 'üéâ';
    else if (pct >= 50) emoji = 'üí™';
    document.getElementById('resultsEmoji').textContent = emoji;

    if (wrong === 0) {
        document.getElementById('btnWrong').style.display = 'none';
    }

    document.querySelector('.study-wrapper').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'flex';

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    fetch(`/study/${COURSE_PK}/results/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ correct, total, wrong_ids: wrongIds })
    });
}

function restartAll() {
    activeCards = [...CARDS];
    currentIndex = 0;
    correctIds = [];
    wrongIds = [];
    document.querySelector('.study-wrapper').style.display = 'flex';
    document.getElementById('resultsScreen').style.display = 'none';
    showCard(0);
}

function restartWrong() {
    activeCards = CARDS.filter(c => wrongIds.includes(c.id));
    currentIndex = 0;
    correctIds = [];
    wrongIds = [];
    document.querySelector('.study-wrapper').style.display = 'flex';
    document.getElementById('resultsScreen').style.display = 'none';
    showCard(0);
}

function goToTest() {
    window.location.href = `/test/${COURSE_PK}/`;
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

init();
</script>
{% endblock %}