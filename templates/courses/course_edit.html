{% extends 'base.html' %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî {{ course.title }}{% endblock %}

{% block content %}
<div class="edit-page">
    <div class="edit-header">
        <h1>‚úèÔ∏è {{ course.title }}</h1>
        <a href="{% url 'course_detail' course.pk %}" class="btn-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—É—Ä—Å–∞ -->
    <div class="course-settings-panel">
        <form method="post">
            {% csrf_token %}
            <div class="settings-row">
                <div class="settings-field">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                    {{ course_form.title }}
                </div>
                <div class="settings-field">
                    <label>–ü–∞–ø–∫–∞</label>
                    {{ course_form.folder }}
                </div>
                <div class="settings-field">
                    <label>–Ø–∑—ã–∫ (–ª–∏—Ü–µ–≤–∞—è)</label>
                    {{ course_form.front_language }}
                </div>
                <div class="settings-field">
                    <label>–Ø–∑—ã–∫ (–∑–∞–¥–Ω—è—è)</label>
                    {{ course_form.back_language }}
                </div>
            </div>
            <button type="submit" name="save_course" class="btn-secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </form>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="cards-editor">
        <h2>–ö–∞—Ä—Ç–æ—á–∫–∏ ({{ cards.count }})</h2>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <form method="post" enctype="multipart/form-data" class="add-card-form">
            {% csrf_token %}
            <div class="card-inputs">
                <div class="input-group">
                    <label>{{ course.front_language|upper }} ‚Äî —Å–ª–æ–≤–æ</label>
                    {{ card_form.front_text }}
                    <div class="translation-hint" id="translation-hint"></div>
                </div>
                <div class="arrow">‚Üí</div>
                <div class="input-group">
                    <label>{{ course.back_language|upper }} ‚Äî –ø–µ—Ä–µ–≤–æ–¥</label>
                    {{ card_form.back_text }}
                </div>
                <div class="input-group">
                    <label>–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    {{ card_form.image }}
                </div>
            </div>
            <button type="submit" name="add_card" class="btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
        </form>

        <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
        <div class="cards-list">
            {% for card in cards %}
            <div class="card-row">
                <span class="card-num">{{ forloop.counter }}</span>
                <div class="card-texts">
                    <span class="front">{{ card.front_text }}</span>
                    <span class="arrow-small">‚Üí</span>
                    <span class="back">{{ card.back_text }}</span>
                </div>
                {% if card.image %}
                <img src="{{ card.image.url }}" alt="" class="card-thumb">
                {% endif %}
                <button class="fav-btn {% if card.is_favorite %}active{% endif %}"
                    onclick="toggleFav({{ card.pk }}, this)">‚òÖ</button>
                <a href="{% url 'card_delete' card.pk %}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?')"
                    class="btn-danger-sm">‚úï</a>
            </div>
            {% empty %}
            <p class="empty-cards">–ö–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é!</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    const frontInput = document.querySelector('.card-front-input');
    const backInput = document.querySelector('.card-back-input');
    const hint = document.getElementById('translation-hint');
    let timer;

    // –ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –ü–ï–†–í–û–ï –ø–æ–ª–µ
    frontInput.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(() => fetchTranslation(
            frontInput.value.trim(),
            '{{ course.front_language }}',
            '{{ course.back_language }}',
            backInput
        ), 600);
    });

    // –ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –í–¢–û–†–û–ï –ø–æ–ª–µ (–µ—Å–ª–∏ –ø–µ—Ä–≤–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
    backInput.addEventListener('focus', () => {
        const word = frontInput.value.trim();
        if (word.length >= 2 && !backInput.value) {
            fetchTranslation(word, '{{ course.front_language }}', '{{ course.back_language }}', backInput);
        }
    });

    function fetchTranslation(word, sourceLang, targetLang, targetInput) {
        if (word.length < 2) { hint.innerHTML = ''; return; }

        fetch(`/api/translate/?word=${encodeURIComponent(word)}&source=${sourceLang}&target=${targetLang}`)
            .then(r => r.json())
            .then(data => {
                if (data.translations && data.translations.length > 0) {
                    hint.innerHTML = data.translations.map(t =>
                        `<span class="hint-chip" onclick="
                        document.querySelector('.card-back-input').value='${t.replace(/'/g, "\\'")}';
                        document.getElementById('translation-hint').innerHTML='';
                    ">${t}</span>`
                    ).join('');
                }
            })
            .catch(() => { });
    }
</script>
{% endblock %}