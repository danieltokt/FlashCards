{% extends 'base.html' %}
{% block title %}{{ chat.title }}{% endblock %}

{% block content %}
<div class="chat-layout">

    <!-- –°–∞–π–¥–±–∞—Ä —Å–æ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤ -->
    <div class="chat-sidebar">
        <a href="{% url 'ai_chat_create' %}" class="btn-primary" style="display:block;text-align:center;margin-bottom:1rem">
            + –ù–æ–≤—ã–π —á–∞—Ç
        </a>
        <div class="sidebar-chats">
            {% for c in chats %}
            <a href="{% url 'ai_chat' c.pk %}"
               class="sidebar-chat-item {% if c.pk == chat.pk %}active{% endif %}">
                <div class="sidebar-chat-title">{{ c.title }}</div>
                <div class="sidebar-chat-meta">{{ c.updated_at|date:"d.m" }}</div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="chat-main">

        <div class="chat-header">
            <div class="chat-title-wrap">
                <h2 id="chatTitle">{{ chat.title }}</h2>
                <button onclick="renameChat()" class="icon-btn" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            </div>
            <div style="display:flex;gap:0.5rem">
                <form method="post" action="{% url 'ai_chat_delete' chat.pk %}"
                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?')">
                    {% csrf_token %}
                    <button type="submit" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div class="quick-prompts">
            <button class="prompt-chip" onclick="setPrompt('–û–±—ä—è—Å–Ω–∏ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É Present Simple –∏ Present Continuous')">Present Simple vs Continuous</button>
            <button class="prompt-chip" onclick="setPrompt('–ü—Ä–æ–≤–µ—Ä—å –º–æ–π —Ç–µ–∫—Å—Ç –Ω–∞ –æ—à–∏–±–∫–∏: ')">‚úèÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            <button class="prompt-chip" onclick="setPrompt('–ü—Ä–∏–¥—É–º–∞–π 5 –ø—Ä–∏–º–µ—Ä–æ–≤ —Å–æ —Å–ª–æ–≤–æ–º ')">üìù –ü—Ä–∏–º–µ—Ä—ã —Å —Å–ª–æ–≤–æ–º</button>
            <button class="prompt-chip" onclick="setPrompt('–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ä—Ç–∏–∫–ª–∏ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º?')">–ê—Ä—Ç–∏–∫–ª–∏</button>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="chat-messages" id="chatMessages">
            {% if not messages %}
            <div class="chat-empty">
                <div style="font-size:3rem">ü§ñ</div>
                <p>–ù–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥! –°–ø—Ä–æ—Å–∏ –æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç.</p>
            </div>
            {% endif %}
            {% for msg in messages %}
            <div class="chat-msg {% if msg.role == 'user' %}msg-user{% else %}msg-bot{% endif %}">
                <div class="msg-avatar">{% if msg.role == 'user' %}üë§{% else %}ü§ñ{% endif %}</div>
                <div class="msg-bubble">
                    <div class="msg-text">{{ msg.content|linebreaksbr }}</div>
                    <div class="msg-time">{{ msg.created_at|date:"H:i" }}</div>
                </div>
            </div>
            {% endfor %}
            <div class="chat-msg msg-bot" id="typingIndicator" style="display:none">
                <div class="msg-avatar">ü§ñ</div>
                <div class="msg-bubble">
                    <div class="typing-dots"><span></span><span></span><span></span></div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="chat-input-wrap">
            <textarea id="chatInput" class="chat-input"
                placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1"
                onInput="autoResize(this)"></textarea>
            <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
        </div>
        <div class="chat-hint">Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
    </div>
</div>

<script>
const CHAT_PK = {{ chat.pk }};

function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    appendMessage('user', text);
    input.value = '';
    autoResize(input);
    document.getElementById('typingIndicator').style.display = 'flex';
    document.getElementById('sendBtn').disabled = true;
    scrollToBottom();

    fetch(`/ai/${CHAT_PK}/send/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ message: text })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('typingIndicator').style.display = 'none';
        document.getElementById('sendBtn').disabled = false;
        if (data.status === 'ok') {
            appendMessage('assistant', data.reply);
        } else {
            const msg = data.message === 'RATE_LIMIT'
                ? '‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç (15 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω). –ü–æ–¥–æ–∂–¥–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å —Å–Ω–æ–≤–∞.'
                : '‚ùå –û—à–∏–±–∫–∞: ' + (data.message || '–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
            appendMessage('assistant', msg);
        }
        scrollToBottom();
    });
}

function appendMessage(role, text) {
    const container = document.getElementById('chatMessages');
    const empty = container.querySelector('.chat-empty');
    if (empty) empty.remove();

    const now = new Date();
    const time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
    const div = document.createElement('div');
    div.className = `chat-msg ${role === 'user' ? 'msg-user' : 'msg-bot'}`;
    div.innerHTML = `
        <div class="msg-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
        <div class="msg-bubble">
            <div class="msg-text">${formatText(text)}</div>
            <div class="msg-time">${time}</div>
        </div>`;
    container.insertBefore(div, document.getElementById('typingIndicator'));
}

function formatText(text) {
    return text
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>')
        .replace(/`(.*?)`/g,'<code>$1</code>')
        .replace(/\n/g,'<br>');
}

function renameChat() {
    const current = document.getElementById('chatTitle').textContent;
    const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', current);
    if (!newTitle || newTitle.trim() === current) return;

    fetch(`/ai/${CHAT_PK}/rename/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ title: newTitle.trim() })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            document.getElementById('chatTitle').textContent = data.title;
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Å–∞–π–¥–±–∞—Ä–µ
            document.querySelectorAll('.sidebar-chat-item.active .sidebar-chat-title')
                .forEach(el => el.textContent = data.title);
        }
    });
}

function clearChat() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —ç—Ç–æ–≥–æ —á–∞—Ç–∞?')) return;
    fetch(`/ai/${CHAT_PK}/clear/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    }).then(() => {
        document.getElementById('chatMessages').innerHTML = `
            <div class="chat-empty">
                <div style="font-size:3rem">ü§ñ</div>
                <p>–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.</p>
            </div>`;
    });
}

function setPrompt(text) {
    const input = document.getElementById('chatInput');
    input.value = text;
    input.focus();
    autoResize(input);
    input.setSelectionRange(text.length, text.length);
}

function scrollToBottom() {
    const c = document.getElementById('chatMessages');
    c.scrollTop = c.scrollHeight;
}

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

document.getElementById('chatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); sendMessage(); }
});

function getCookie(name) {
    const v = `; ${document.cookie}`.split(`; ${name}=`);
    if (v.length === 2) return v.pop().split(';').shift();
}

scrollToBottom();
</script>
{% endblock %}